<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Course Data Editor</title>
  <style>
    :root {
      --primary-color: #4A90E2;
      --secondary-color: #FF3B30;
      --success-color: #30D158;
      --warning-color: #FFCC00;
      --purple-color: #5856D6;
      --orange-color: #FF9500;
      --background-color: #f5f7fa;
      --sidebar-bg: #fff;
      --card-bg: #fff;
      --border-color: #e1e4e8;
      --text-color: #333;
      --text-muted: #6c757d;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--background-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      background-color: var(--primary-color);
      color: white;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .app-title {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 600;
    }
    .header-actions {
      display: flex;
      gap: 0.5rem;
    }
    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    .btn-primary {
      background-color: white;
      color: var(--primary-color);
    }
    .btn-secondary {
      background-color: rgba(255, 255, 255, 0.2);
      color: white;
    }
    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    .container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    .sidebar {
      width: 300px;
      background-color: var(--sidebar-bg);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .search-container {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    .search-input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }
    .tree-view {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }
    .tree-item {
      margin-bottom: 0.25rem;
    }
    .tree-item-header {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .tree-item-header:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }
    .tree-item-header.active {
      background-color: rgba(74, 144, 226, 0.1);
      font-weight: 500;
    }
    .tree-item-children {
      margin-left: 1.5rem;
      overflow: hidden;
      max-height: 0;
      transition: max-height 0.3s ease-out;
    }
    .tree-item-children.expanded {
      max-height: 1000px;
    }
    .color-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 0.5rem;
    }
    .main-content {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
    }
    .editor-container {
      background-color: var(--card-bg);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    .editor-tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
      background-color: #f8f9fa;
    }
    .editor-tab {
      padding: 0.75rem 1rem;
      cursor: pointer;
      font-weight: 500;
      border-bottom: 2px solid transparent;
    }
    .editor-tab.active {
      border-bottom-color: var(--primary-color);
      color: var(--primary-color);
    }
    .editor-content {
      padding: 1.5rem;
    }
    .form-group {
      margin-bottom: 1rem;
    }
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    .form-control {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-family: inherit;
    }
    textarea.form-control {
      min-height: 80px;
      resize: vertical;
    }
    .form-row {
      display: flex;
      gap: 1rem;
    }
    .form-col {
      flex: 1;
    }
    .action-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .btn-success {
      background-color: var(--success-color);
      color: white;
    }
    .btn-danger {
      background-color: var(--secondary-color);
      color: white;
    }
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .stat-card {
      background-color: var(--card-bg);
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--primary-color);
    }
    .stat-label {
      color: var(--text-muted);
      font-weight: 500;
    }
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 1rem;
      background-color: var(--success-color);
      color: white;
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
    }
    .notification.show {
      transform: translateY(0);
      opacity: 1;
    }
    .array-item {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .array-item .form-control {
      flex: 1;
    }
    .btn-sm {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
    }
    .array-actions {
      margin-top: 0.5rem;
    }
    .checkbox-container {
      display: flex;
      align-items: center;
    }
    .checkbox-container input {
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
  <header>
    <h1 class="app-title">Course Data Editor</h1>
    <div class="header-actions">
      <button id="saveBtn" class="btn btn-primary">Save Data</button>
      <button id="exportBtn" class="btn btn-secondary">Export JSON</button>
      <label for="importFile" class="btn btn-secondary" style="cursor: pointer;">Import JSON</label>
      <input type="file" id="importFile" accept=".json" style="display: none;">
    </div>
  </header>
  <div class="container">
    <div class="sidebar">
      <div class="search-container">
        <input type="text" id="searchInput" class="search-input" placeholder="Search...">
      </div>
      <div class="tree-view" id="treeView">
        <div id="tree-container"></div>
      </div>
    </div>
    <div class="main-content" id="mainContent">
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-value" id="totalCategories">0</div>
          <div class="stat-label">Categories</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalSections">0</div>
          <div class="stat-label">Sections</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalModules">0</div>
          <div class="stat-label">Modules</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalSubmodules">0</div>
          <div class="stat-label">Submodules</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalDuration">0</div>
          <div class="stat-label">Total Minutes</div>
        </div>
        <!-- Boolean true counts -->
        <div class="stat-card">
          <div class="stat-value" id="founderMustWatchTrue">0</div>
          <div class="stat-label">Founder Must Watch (true)</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="entrepreneurSpecificTrue">0</div>
          <div class="stat-label">Entrepreneur Specific (true)</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="popularTrue">0</div>
          <div class="stat-label">Popular (true)</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="featuredTrue">0</div>
          <div class="stat-label">Featured (true)</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="highValueTrue">0</div>
          <div class="stat-label">High Value (true)</div>
        </div>
        <!-- Resource counts -->
        <div class="stat-card">
          <div class="stat-value" id="pdfCount">0</div>
          <div class="stat-label">PDFs</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="worksheetsCount">0</div>
          <div class="stat-label">Worksheets</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="workshopCount">0</div>
          <div class="stat-label">Workshops</div>
        </div>
      </div>
      <div class="editor-container">
        <div class="editor-content">
          <h2>Welcome to the Course Data Editor</h2>
          <p>Select an item from the sidebar to begin editing or use the search to find specific content.</p>
        </div>
      </div>
    </div>
  </div>
  <div class="notification" id="notification">
    Changes saved successfully!
  </div>
  <script>
    // Get element references
    const saveBtn = document.getElementById('saveBtn');
    const exportBtn = document.getElementById('exportBtn');
    const importFile = document.getElementById('importFile');
    const searchInput = document.getElementById('searchInput');
    const treeView = document.getElementById('treeView');
    const editorContainer = document.querySelector('.editor-container');
    
    let courseData = null;
    let currentSelectedItem = null;
    let searchTimeout = null;
    let currentEditPath = null;
    
    // Utility function to escape HTML special characters
    function escapeHtml(text) {
      if (!text) return '';
      return String(text)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
    
    // Initialize the application
    function init() {
      console.log('Initializing application...');
      setupEventListeners();
      loadJSONData();
    }
    
    window.onload = init;
    
    // Load JSON data from localStorage or default
    function loadJSONData() {
      const defaultCourse = {
        "title": "New Course",
        "categories": []
      };
      console.log('Attempting to load course data...');
      try {
        // If you previously saved data, load it from localStorage.
        // Otherwise, use convertedCourseData (if defined) or default.
        const storedData = localStorage.getItem('courseData');
        if (storedData) {
          courseData = JSON.parse(storedData);
        } else {
          courseData = (typeof convertedCourseData !== 'undefined') ? convertedCourseData : defaultCourse;
        }
        console.log('Course data loaded successfully!');
        renderTreeView();
        updateStatistics();
        showNotification('Course data loaded successfully');
      } catch (error) {
        console.error('Error loading course data:', error);
        courseData = defaultCourse;
        showNotification('Error loading course data. Using empty template.', 'error');
        renderTreeView();
        updateStatistics();
      }
    }
    
    // Import data from file
    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const jsonData = JSON.parse(e.target.result);
          courseData = jsonData;
          // Also save to localStorage so changes persist
          localStorage.setItem('courseData', JSON.stringify(courseData));
          renderTreeView();
          updateStatistics();
          showNotification('Course data imported successfully');
        } catch (error) {
          console.error('Error parsing JSON', error);
          showNotification('Error parsing JSON', 'error');
        }
      };
      reader.readAsText(file);
    }
    
    // Export updated data as a file
    function exportData() {
      try {
        const dataStr = JSON.stringify(courseData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'course-data.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showNotification('Data exported successfully');
      } catch (error) {
        console.error('Error exporting data', error);
        showNotification('Error exporting data', 'error');
      }
    }
    
    // Update statistics, including booleans and resources
    function updateStatistics() {
      let totalCategories = 0;
      let totalSections = 0;
      let totalModules = 0;
      let totalSubmodules = 0;
      let totalDuration = 0;
      
      let countFounderMustWatchTrue = 0;
      let countEntrepreneurSpecificTrue = 0;
      let countPopularTrue = 0;
      let countFeaturedTrue = 0;
      let countHighValueTrue = 0;
      
      let countPdf = 0;
      let countWorksheets = 0;
      let countWorkshop = 0;
      
      if (courseData && Array.isArray(courseData.categories)) {
        totalCategories = courseData.categories.length;
        courseData.categories.forEach(category => {
          if (Array.isArray(category.sections)) {
            totalSections += category.sections.length;
            category.sections.forEach(section => {
              if (Array.isArray(section.modules)) {
                totalModules += section.modules.length;
                section.modules.forEach(module => {
                  if (typeof module.duration === 'number') {
                    totalDuration += module.duration;
                  }
                  if (module.founderMustWatch === true) countFounderMustWatchTrue++;
                  if (module.entrepreneurSpecific === true) countEntrepreneurSpecificTrue++;
                  if (module.popular === true) countPopularTrue++;
                  if (module.featured === true) countFeaturedTrue++;
                  
                  if (Array.isArray(module.submodules)) {
                    totalSubmodules += module.submodules.length;
                    module.submodules.forEach(sub => {
                      if (typeof sub.duration === 'number') {
                        totalDuration += sub.duration;
                      }
                      if (sub.highValue === true) countHighValueTrue++;
                      if (Array.isArray(sub.resources)) {
                        sub.resources.forEach(resource => {
                          const res = resource.toLowerCase();
                          if (res === 'pdf') countPdf++;
                          else if (res === 'worksheets') countWorksheets++;
                          else if (res === 'workshop') countWorkshop++;
                        });
                      }
                    });
                  }
                });
              }
            });
          }
        });
      }
      
      document.getElementById('totalCategories').textContent = totalCategories;
      document.getElementById('totalSections').textContent = totalSections;
      document.getElementById('totalModules').textContent = totalModules;
      document.getElementById('totalSubmodules').textContent = totalSubmodules;
      document.getElementById('totalDuration').textContent = totalDuration;
      
      document.getElementById('founderMustWatchTrue').textContent = countFounderMustWatchTrue;
      document.getElementById('entrepreneurSpecificTrue').textContent = countEntrepreneurSpecificTrue;
      document.getElementById('popularTrue').textContent = countPopularTrue;
      document.getElementById('featuredTrue').textContent = countFeaturedTrue;
      document.getElementById('highValueTrue').textContent = countHighValueTrue;
      
      document.getElementById('pdfCount').textContent = countPdf;
      document.getElementById('worksheetsCount').textContent = countWorksheets;
      document.getElementById('workshopCount').textContent = countWorkshop;
    }
    
    // Render the tree view based on courseData
    function renderTreeView() {
      const treeContainer = document.getElementById('tree-container');
      treeContainer.innerHTML = '';
      
      // Create the course header
      const courseHeader = document.createElement('div');
      courseHeader.className = 'tree-item';
      courseHeader.innerHTML = `
        <div class="tree-item-header">
          <span class="tree-icon">📚</span>
          <span class="tree-label">${courseData.title || 'Course'}</span>
        </div>
      `;
      treeContainer.appendChild(courseHeader);
      
      // Create the categories container
      const categoriesContainer = document.createElement('div');
      categoriesContainer.className = 'tree-item-children expanded';
      treeContainer.appendChild(categoriesContainer);
      
      // Add the tracks section
      if (courseData.tracks && courseData.tracks.length > 0) {
        const tracksContainer = document.createElement('div');
        tracksContainer.className = 'tree-item';
        tracksContainer.innerHTML = `
          <div class="tree-item-header">
            <span class="tree-icon">🛤️</span>
            <span class="tree-label">Tracks (${courseData.tracks.length})</span>
          </div>
        `;
        categoriesContainer.appendChild(tracksContainer);
        
        const tracksItemsContainer = document.createElement('div');
        tracksItemsContainer.className = 'tree-item-children';
        tracksContainer.appendChild(tracksItemsContainer);
        
        courseData.tracks.forEach((track, tIndex) => {
          const trackItem = document.createElement('div');
          trackItem.className = 'tree-item';
          trackItem.innerHTML = `
            <div class="tree-item-header" data-id="track_${tIndex}">
              <span class="tree-icon" style="color: ${track.color || '#888'}">${track.icon || '🔹'}</span>
              <span class="tree-label">${track.name || `Track ${tIndex + 1}`}</span>
            </div>
          `;
          tracksItemsContainer.appendChild(trackItem);
        });
      }
      
      // Add the infrastructure section
      if (courseData.infrastructure && courseData.infrastructure.length > 0) {
        const infraContainer = document.createElement('div');
        infraContainer.className = 'tree-item';
        infraContainer.innerHTML = `
          <div class="tree-item-header">
            <span class="tree-icon">🏗️</span>
            <span class="tree-label">Infrastructure (${courseData.infrastructure.length})</span>
          </div>
        `;
        categoriesContainer.appendChild(infraContainer);
        
        const infraItemsContainer = document.createElement('div');
        infraItemsContainer.className = 'tree-item-children';
        infraContainer.appendChild(infraItemsContainer);
        
        courseData.infrastructure.forEach((infra, infIndex) => {
          const infraItem = document.createElement('div');
          infraItem.className = 'tree-item';
          infraItem.innerHTML = `
            <div class="tree-item-header" data-id="infrastructure_${infIndex}">
              <span class="tree-icon" style="color: ${infra.color || '#888'}">${infra.icon || '🔧'}</span>
              <span class="tree-label">${infra.title || `Component ${infIndex + 1}`}</span>
            </div>
          `;
          infraItemsContainer.appendChild(infraItem);
        });
      }
      
      // Render categories
      if (courseData.categories && courseData.categories.length > 0) {
        courseData.categories.forEach((category, catIndex) => {
          const categoryItem = document.createElement('div');
          categoryItem.className = 'tree-item';
          const categoryHeader = document.createElement('div');
          categoryHeader.className = 'tree-item-header';
          categoryHeader.setAttribute('data-id', `category_${catIndex}`);
          const colorIndicator = document.createElement('div');
          colorIndicator.className = 'color-indicator';
          colorIndicator.style.backgroundColor = category.color || '#4A90E2';
          const nameSpan = document.createElement('span');
          nameSpan.textContent = category.name || `Category ${catIndex + 1}`;
          categoryHeader.appendChild(colorIndicator);
          categoryHeader.appendChild(nameSpan);
          categoryItem.appendChild(categoryHeader);
          
          const childrenContainer = document.createElement('div');
          childrenContainer.className = 'tree-item-children';
          if (Array.isArray(category.sections)) {
            category.sections.forEach((section, secIndex) => {
              const sectionItem = document.createElement('div');
              sectionItem.className = 'tree-item';
              const sectionHeader = document.createElement('div');
              sectionHeader.className = 'tree-item-header';
              sectionHeader.setAttribute('data-id', `section_${catIndex}_${secIndex}`);
              const sectionName = document.createElement('span');
              sectionName.textContent = `${section.number}. ${section.name}`;
              sectionHeader.appendChild(sectionName);
              sectionItem.appendChild(sectionHeader);
              
              const modulesContainer = document.createElement('div');
              modulesContainer.className = 'tree-item-children';
              if (Array.isArray(section.modules)) {
                section.modules.forEach((module, modIndex) => {
                  const moduleItem = document.createElement('div');
                  moduleItem.className = 'tree-item';
                  const moduleHeader = document.createElement('div');
                  moduleHeader.className = 'tree-item-header';
                  moduleHeader.setAttribute('data-id', `module_${catIndex}_${secIndex}_${modIndex}`);
                  const modColor = document.createElement('div');
                  modColor.className = 'color-indicator';
                  modColor.style.backgroundColor = module.color || '#000000';
                  const modName = document.createElement('span');
                  modName.textContent = module.title;
                  moduleHeader.appendChild(modColor);
                  moduleHeader.appendChild(modName);
                  moduleItem.appendChild(moduleHeader);
                  
                  const submodulesContainer = document.createElement('div');
                  submodulesContainer.className = 'tree-item-children';
                  if (Array.isArray(module.submodules)) {
                    module.submodules.forEach((submodule, subIndex) => {
                      const subItem = document.createElement('div');
                      subItem.className = 'tree-item';
                      const subHeader = document.createElement('div');
                      subHeader.className = 'tree-item-header';
                      subHeader.setAttribute('data-id', `submodule_${catIndex}_${secIndex}_${modIndex}_${subIndex}`);
                      const subName = document.createElement('span');
                      subName.textContent = submodule.title;
                      subHeader.appendChild(subName);
                      subItem.appendChild(subHeader);
                      submodulesContainer.appendChild(subItem);
                    });
                  }
                  moduleItem.appendChild(submodulesContainer);
                  modulesContainer.appendChild(moduleItem);
                });
              }
              sectionItem.appendChild(modulesContainer);
              childrenContainer.appendChild(sectionItem);
            });
          }
          categoryItem.appendChild(childrenContainer);
          categoriesContainer.appendChild(categoryItem);
        });
      }
    }
    
    // Handle clicks in the tree view
    function handleTreeViewClick(event) {
      const target = event.target.closest('.tree-item-header');
      if (!target) return;

      // Check if we should toggle a branch
      const parent = target.parentElement;
      const children = parent.querySelector('.tree-item-children');
      if (children) {
        children.classList.toggle('expanded');
        return;
      }

      // Otherwise, we should open an editor
      const itemId = target.getAttribute('data-id');
      if (!itemId) return;

      console.log('Opening editor for:', itemId);
      const [type, indexStr] = itemId.split('_');
      const index = parseInt(indexStr, 10);

      if (type === 'category') {
        renderCategoryEditor(index);
      } else if (type === 'section') {
        const [categoryIndex, sectionIndex] = indexStr.split('-').map(n => parseInt(n, 10));
        renderSectionEditor(categoryIndex, sectionIndex);
      } else if (type === 'module') {
        const [categoryIndex, sectionIndex, moduleIndex] = indexStr.split('-').map(n => parseInt(n, 10));
        renderModuleEditor(categoryIndex, sectionIndex, moduleIndex);
      } else if (type === 'submodule') {
        const [categoryIndex, sectionIndex, moduleIndex, submoduleIndex] = indexStr.split('-').map(n => parseInt(n, 10));
        renderSubmoduleEditor(categoryIndex, sectionIndex, moduleIndex, submoduleIndex);
      } else if (type === 'track') {
        renderTrackEditor(index);
      } else if (type === 'infrastructure') {
        renderInfrastructureEditor(index);
      }
    }
    
    // Module editor: renders module and its submodules for editing
    function renderModuleEditor(catIndex, secIndex, modIndex) {
      const module = courseData.categories[catIndex].sections[secIndex].modules[modIndex];
      editorContainer.querySelector('.editor-content').innerHTML = `
        <h2>Edit Module</h2>
        <div class="form-group">
          <label>Module Title</label>
          <input type="text" name="moduleTitle" value="${module.title}" />
        </div>
        <div class="form-group">
          <label>Module Subtitle</label>
          <input type="text" name="moduleSubtitle" value="${module.subtitle}" />
        </div>
        <div class="form-group">
          <label>Icon</label>
          <input type="text" name="moduleIcon" value="${module.icon}" />
        </div>
        <div class="form-group">
          <label>Color</label>
          <input type="color" name="moduleColor" value="${module.color}" />
        </div>
        <div class="form-group">
          <label>Thumbnail</label>
          <input type="text" name="moduleThumbnail" value="${module.thumbnail}" />
        </div>
        <div class="form-group">
          <label>Duration (minutes)</label>
          <input type="number" name="moduleDuration" value="${module.duration}" />
        </div>
        <div class="checkbox-group">
          <label>
            <input type="checkbox" name="founderMustWatch" ${module.founderMustWatch ? 'checked' : ''} />
            Founder Must Watch
          </label>
          <label>
            <input type="checkbox" name="entrepreneurSpecific" ${module.entrepreneurSpecific ? 'checked' : ''} />
            Entrepreneur Specific
          </label>
          <label>
            <input type="checkbox" name="popular" ${module.popular ? 'checked' : ''} />
            Popular
          </label>
          <label>
            <input type="checkbox" name="featured" ${module.featured ? 'checked' : ''} />
            Featured
          </label>
        </div>
        <h3>Submodules</h3>
        <div class="submodules-list">
          ${ module.submodules.map((sub, subIndex) => `
            <div class="submodule-item" data-submodule-index="${subIndex}">
              <div class="form-group">
                <label>Title</label>
                <input type="text" name="subTitle" value="${sub.title}" />
              </div>
              <div class="form-group">
                <label>Subtitle</label>
                <input type="text" name="subSubtitle" value="${sub.subtitle}" />
              </div>
              <div class="form-group">
                <label>Duration</label>
                <input type="number" name="subDuration" value="${sub.duration}" />
              </div>
              <div class="form-group">
                <label>Difficulty</label>
                <input type="number" name="subDifficulty" value="${sub.difficulty}" />
              </div>
              <div class="form-group">
                <label>Resources (comma-separated)</label>
                <input type="text" name="subResources" value="${(sub.resources || []).join(',')}" />
              </div>
              <div class="form-group">
                <label>High Value</label>
                <input type="checkbox" name="subHighValue" ${sub.highValue ? 'checked' : ''} />
              </div>
            </div>
          `).join('') }
          <button id="addSubmoduleBtn">Add Submodule</button>
        </div>
        <button class="save-changes-button">Save Module Changes</button>
      `;
      
      // Save changes for module and its submodules
      const saveChangesBtn = editorContainer.querySelector('.save-changes-button');
      saveChangesBtn.addEventListener('click', () => {
        // Update module properties
        module.title = editorContainer.querySelector('input[name="moduleTitle"]').value;
        module.subtitle = editorContainer.querySelector('input[name="moduleSubtitle"]').value;
        module.icon = editorContainer.querySelector('input[name="moduleIcon"]').value;
        module.color = editorContainer.querySelector('input[name="moduleColor"]').value;
        module.thumbnail = editorContainer.querySelector('input[name="moduleThumbnail"]').value;
        module.duration = parseInt(editorContainer.querySelector('input[name="moduleDuration"]').value, 10) || 0;
        module.founderMustWatch = editorContainer.querySelector('input[name="founderMustWatch"]').checked;
        module.entrepreneurSpecific = editorContainer.querySelector('input[name="entrepreneurSpecific"]').checked;
        module.popular = editorContainer.querySelector('input[name="popular"]').checked;
        module.featured = editorContainer.querySelector('input[name="featured"]').checked;
        
        // Update submodules
        const subItems = editorContainer.querySelectorAll('.submodule-item');
        subItems.forEach(item => {
          const index = parseInt(item.getAttribute('data-submodule-index'), 10);
          const sub = module.submodules[index];
          sub.title = item.querySelector('input[name="subTitle"]').value;
          sub.subtitle = item.querySelector('input[name="subSubtitle"]').value;
          sub.duration = parseInt(item.querySelector('input[name="subDuration"]').value, 10) || 0;
          sub.difficulty = parseInt(item.querySelector('input[name="subDifficulty"]').value, 10) || 1;
          const resourcesStr = item.querySelector('input[name="subResources"]').value;
          sub.resources = resourcesStr.split(',').map(r => r.trim()).filter(Boolean);
          sub.highValue = item.querySelector('input[name="subHighValue"]').checked;
        });
        
        // Save updated data to localStorage (optional)
        localStorage.setItem('courseData', JSON.stringify(courseData));
        updateStatistics();
        renderTreeView();
        showNotification('Module updated successfully!');
      });
      
      // (Optional) Add a button to add a new submodule
      const addSubBtn = editorContainer.querySelector('#addSubmoduleBtn');
      addSubBtn.addEventListener('click', () => {
        // Append a new submodule to the module's submodules array
        const newSub = {
          id: `new_${Date.now()}`,
          title: 'New Submodule',
          subtitle: '',
          duration: 0,
          difficulty: 1,
          resources: [],
          highValue: false,
          week: 0,
          instructor: ''
        };
        module.submodules.push(newSub);
        // Re-render the module editor to show the new submodule
        renderModuleEditor(catIndex, secIndex, modIndex);
      });
    }
    
    // Track editor: allows editing track properties
    function renderTrackEditor(trackIndex) {
      const track = courseData.tracks[trackIndex];
      editorContainer.querySelector('.editor-content').innerHTML = `
        <h2>Edit Track</h2>
        <div class="form-group">
          <label>Name</label>
          <input type="text" name="trackName" value="${track.name || ''}" />
        </div>
        <div class="form-group">
          <label>ID</label>
          <input type="text" name="trackId" value="${track.id || ''}" />
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea name="trackDescription" class="form-control">${track.description || ''}</textarea>
        </div>
        <div class="form-group">
          <label>Color</label>
          <input type="color" name="trackColor" value="${track.color || '#154D59'}" />
        </div>
        <div class="form-group">
          <label>Order</label>
          <input type="number" name="trackOrder" value="${track.order || trackIndex + 1}" />
        </div>
        <div class="form-group">
          <label>Icon</label>
          <input type="text" name="trackIcon" value="${track.icon || '⚙️'}" />
        </div>
        <div class="form-group">
          <label>Required</label>
          <input type="checkbox" name="trackRequired" ${track.required ? 'checked' : ''} />
        </div>
        <h3>Associated Modules</h3>
        <div id="trackModules" class="associated-modules">
          ${displayAssociatedModules(track)}
        </div>
        <button class="save-track-button">Save Track Changes</button>
      `;
      
      // Function to display modules associated with this track
      function displayAssociatedModules(track) {
        let modulesHTML = '<div class="module-list">';
        let associatedModuleIds = track.moduleIds || [];
        
        // Loop through categories, sections, and modules to find modules with matching IDs
        courseData.categories.forEach(category => {
          if (Array.isArray(category.sections)) {
            category.sections.forEach(section => {
              if (Array.isArray(section.modules)) {
                section.modules.forEach(module => {
                  const isAssociated = associatedModuleIds.includes(module.id);
                  modulesHTML += `
                    <div class="module-item">
                      <input type="checkbox" name="module_${module.id}" ${isAssociated ? 'checked' : ''} data-module-id="${module.id}" />
                      <span>${module.title}</span>
                      <span class="module-path">${category.title} > ${section.title}</span>
                    </div>
                  `;
                });
              }
            });
          }
        });
        modulesHTML += '</div>';
        return modulesHTML;
      }
      
      // Add event listener for the Save button
      const saveTrackBtn = editorContainer.querySelector('.save-track-button');
      saveTrackBtn.addEventListener('click', () => {
        track.name = editorContainer.querySelector('input[name="trackName"]').value;
        track.id = editorContainer.querySelector('input[name="trackId"]').value;
        track.description = editorContainer.querySelector('textarea[name="trackDescription"]').value;
        track.color = editorContainer.querySelector('input[name="trackColor"]').value;
        track.order = parseInt(editorContainer.querySelector('input[name="trackOrder"]').value, 10) || (trackIndex + 1);
        track.icon = editorContainer.querySelector('input[name="trackIcon"]').value;
        track.required = editorContainer.querySelector('input[name="trackRequired"]').checked;
        
        // Update associated modules
        track.moduleIds = [];
        const moduleCheckboxes = editorContainer.querySelectorAll('#trackModules input[type="checkbox"]');
        moduleCheckboxes.forEach(checkbox => {
          if (checkbox.checked) {
            track.moduleIds.push(checkbox.getAttribute('data-module-id'));
          }
        });
        
        // Save to localStorage
        localStorage.setItem('courseData', JSON.stringify(courseData));
        updateStatistics();
        renderTreeView();
        showNotification('Track updated successfully!');
      });
    }
    
    function renderInfrastructureEditor(index) {
      const infrastructure = courseData.infrastructure[index];
      if (!infrastructure) {
        console.error('Infrastructure not found at index:', index);
        return;
      }
      
      // Store the current component we're editing
      currentEditPath = {
        type: 'infrastructure',
        index: index
      };
      
      editorContainer.innerHTML = `
        <h2>Edit Infrastructure Component</h2>
        <form id="infrastructure-form">
          <div class="form-group">
            <label for="infra-title">Title</label>
            <input type="text" id="infra-title" value="${escapeHtml(infrastructure.title || '')}" required>
          </div>
          <div class="form-group">
            <label for="infra-id">ID</label>
            <input type="text" id="infra-id" value="${escapeHtml(infrastructure.id || '')}" required>
          </div>
          <div class="form-group">
            <label for="infra-tagline">Tagline</label>
            <input type="text" id="infra-tagline" value="${escapeHtml(infrastructure.tagline || '')}">
          </div>
          <div class="form-group">
            <label for="infra-description">Description</label>
            <textarea id="infra-description" rows="3">${escapeHtml(infrastructure.description || '')}</textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="infra-order">Order</label>
              <input type="number" id="infra-order" value="${infrastructure.order || 0}" min="0">
            </div>
            <div class="form-group">
              <label for="infra-complexity">Complexity Level</label>
              <select id="infra-complexity">
                <option value="1" ${infrastructure.complexityLevel === 1 ? 'selected' : ''}>1 - Basic</option>
                <option value="2" ${infrastructure.complexityLevel === 2 ? 'selected' : ''}>2 - Intermediate</option>
                <option value="3" ${infrastructure.complexityLevel === 3 ? 'selected' : ''}>3 - Advanced</option>
                <option value="4" ${infrastructure.complexityLevel === 4 ? 'selected' : ''}>4 - Expert</option>
                <option value="5" ${infrastructure.complexityLevel === 5 ? 'selected' : ''}>5 - Master</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="infra-icon">Icon</label>
              <input type="text" id="infra-icon" value="${escapeHtml(infrastructure.icon || '🔧')}" placeholder="Emoji or icon code">
            </div>
            <div class="form-group">
              <label for="infra-color">Color</label>
              <input type="color" id="infra-color" value="${infrastructure.color || '#154D59'}">
            </div>
          </div>
          
          <div class="form-section">
            <h3>Features</h3>
            <div id="features-container">
              ${renderInfrastructureFeatures(infrastructure.features || [])}
            </div>
            <button type="button" id="add-feature-btn" class="btn-secondary">+ Add Feature</button>
          </div>
          
          <div class="form-section">
            <h3>Implementation Details</h3>
            <div id="implementation-container">
              ${renderImplementationDetails(infrastructure.implementationDetails || [])}
            </div>
            <button type="button" id="add-implementation-btn" class="btn-secondary">+ Add Implementation Step</button>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn-primary">Save Changes</button>
            <button type="button" id="delete-infra-btn" class="btn-danger">Delete Component</button>
          </div>
        </form>
      `;
      
      // Add event listeners for the form
      document.getElementById('infrastructure-form').addEventListener('submit', function(e) {
        e.preventDefault();
        saveInfrastructureChanges(index);
      });
      
      // Add event listener for adding features
      document.getElementById('add-feature-btn').addEventListener('click', function() {
        const featuresContainer = document.getElementById('features-container');
        const featureIndex = featuresContainer.children.length;
        
        const featureItem = document.createElement('div');
        featureItem.className = 'array-item';
        featureItem.innerHTML = `
          <input type="text" name="feature_${featureIndex}" placeholder="Feature description" class="feature-input">
          <button type="button" class="btn-icon remove-feature" data-index="${featureIndex}">✕</button>
        `;
        featuresContainer.appendChild(featureItem);
        
        // Add event listener for the remove button
        featureItem.querySelector('.remove-feature').addEventListener('click', function() {
          featuresContainer.removeChild(featureItem);
        });
      });
      
      // Add event listener for adding implementation details
      document.getElementById('add-implementation-btn').addEventListener('click', function() {
        const implementationContainer = document.getElementById('implementation-container');
        const implIndex = implementationContainer.children.length;
        
        const implItem = document.createElement('div');
        implItem.className = 'array-item';
        implItem.innerHTML = `
          <input type="text" name="implementation_${implIndex}" placeholder="Implementation step" class="implementation-input">
          <button type="button" class="btn-icon remove-implementation" data-index="${implIndex}">✕</button>
        `;
        implementationContainer.appendChild(implItem);
        
        // Add event listener for the remove button
        implItem.querySelector('.remove-implementation').addEventListener('click', function() {
          implementationContainer.removeChild(implItem);
        });
      });
      
      // Add event listeners for remove buttons
      document.querySelectorAll('.remove-feature').forEach(button => {
        button.addEventListener('click', function() {
          const featureItem = this.closest('.array-item');
          featureItem.parentElement.removeChild(featureItem);
        });
      });
      
      document.querySelectorAll('.remove-implementation').forEach(button => {
        button.addEventListener('click', function() {
          const implItem = this.closest('.array-item');
          implItem.parentElement.removeChild(implItem);
        });
      });
      
      // Add event listener for delete button
      document.getElementById('delete-infra-btn').addEventListener('click', function() {
        if (confirm('Are you sure you want to delete this infrastructure component?')) {
          courseData.infrastructure.splice(index, 1);
          saveToLocalStorage();
          showNotification('Infrastructure component deleted successfully');
          renderTreeView();
          editorContainer.innerHTML = '';
        }
      });
    }
    
    // Helper function to render infrastructure features
    function renderInfrastructureFeatures(features) {
      if (!Array.isArray(features) || features.length === 0) {
        return '<div class="empty-message">No features added yet</div>';
      }
      
      return features.map((feature, index) => `
        <div class="array-item">
          <input type="text" name="feature_${index}" value="${escapeHtml(feature)}" class="feature-input">
          <button type="button" class="btn-icon remove-feature" data-index="${index}">✕</button>
        </div>
      `).join('');
    }
    
    // Helper function to render implementation details
    function renderImplementationDetails(details) {
      if (!Array.isArray(details) || details.length === 0) {
        return '<div class="empty-message">No implementation details added yet</div>';
      }
      
      return details.map((detail, index) => `
        <div class="array-item">
          <input type="text" name="implementation_${index}" value="${escapeHtml(detail)}" class="implementation-input">
          <button type="button" class="btn-icon remove-implementation" data-index="${index}">✕</button>
        </div>
      `).join('');
    }
    
    // Function to save infrastructure changes
    function saveInfrastructureChanges(index) {
      const infrastructure = courseData.infrastructure[index] || {};
      
      // Update basic information
      infrastructure.title = document.getElementById('infra-title').value;
      infrastructure.id = document.getElementById('infra-id').value;
      infrastructure.tagline = document.getElementById('infra-tagline').value;
      infrastructure.description = document.getElementById('infra-description').value;
      infrastructure.order = parseInt(document.getElementById('infra-order').value, 10) || 0;
      infrastructure.complexityLevel = parseInt(document.getElementById('infra-complexity').value, 10) || 1;
      infrastructure.icon = document.getElementById('infra-icon').value;
      infrastructure.color = document.getElementById('infra-color').value;
      
      // Update features
      infrastructure.features = [];
      document.querySelectorAll('.feature-input').forEach(input => {
        if (input.value.trim()) {
          infrastructure.features.push(input.value.trim());
        }
      });
      
      // Update implementation details
      infrastructure.implementationDetails = [];
      document.querySelectorAll('.implementation-input').forEach(input => {
        if (input.value.trim()) {
          infrastructure.implementationDetails.push(input.value.trim());
        }
      });
      
      // Update the courseData
      courseData.infrastructure[index] = infrastructure;
      
      // Save changes and update UI
      saveToLocalStorage();
      showNotification('Infrastructure component updated successfully');
      renderTreeView();
    }
    
    // Set up global event listeners
    function setupEventListeners() {
      console.log('Setting up event listeners...');
      treeView.addEventListener('click', handleTreeViewClick);
      saveBtn.addEventListener('click', saveData);
      exportBtn.addEventListener('click', exportData);
      if (importFile) {
        importFile.addEventListener('change', importData);
      } else {
        console.error('Import file element not found!');
      }
      searchInput.addEventListener('input', handleSearch);
      console.log('Event listeners set up successfully.');
    }
    
    // Stub: Save data to localStorage
    function saveData() {
      localStorage.setItem('courseData', JSON.stringify(courseData));
      showNotification('Data saved locally');
    }
    
    // Helper function to save data to localStorage
    function saveToLocalStorage() {
      localStorage.setItem('courseData', JSON.stringify(courseData));
    }
    
    // Stub: Export data function (already defined above)
    // Already implemented in exportData()
    
    // Stub: Search handler
    function handleSearch(event) {
      console.log('Search input changed');
      // You can add search logic here.
    }
    
    function showNotification(message, type) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.classList.add('show');
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
  </script>
</body>
</html>